

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Scripting Sculptor 01 - Modelling the example spectrum in a script &mdash; Sculptor 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Scripting Sculptor 02 - Analysing model fits with SpecAnalysis" href="scripting_sculptor_2.html" />
    <link rel="prev" title="Preparing a composite spectrum for Sculptor modeling using the SpecOneD class" href="spectrum_preparation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Sculptor
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">The Sculptor GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="first_fit.html">Spectral fitting with the Sculptor GUI</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="speconed_demonstration.html">An introduction to the SpecOneD class</a></li>
<li class="toctree-l1"><a class="reference internal" href="speconed_demonstration.html#The-PassBand-class">The PassBand class</a></li>
<li class="toctree-l1"><a class="reference internal" href="spectrum_preparation.html">Preparing a composite spectrum for Sculptor modeling using the SpecOneD class</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Scripting Sculptor 01 - Modelling the example spectrum in a script</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Initializing-the-SpecFit-object">Initializing the SpecFit object</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Adding-our-first-SpecModel-object---Fitting-the-continuum">Adding our first SpecModel object - Fitting the continuum</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Adding-and-manipulating-a-SpecModel---Fitting-the-SiIV-line">Adding and manipulating a SpecModel - Fitting the SiIV line</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Fitting-the-CIV-line">Fitting the CIV line</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Fitting-the-CIII]-line">Fitting the CIII] line</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Adding-a-basic-line-model-(Gaussian)---Fitting-absorption-lines">Adding a basic line model (Gaussian) - Fitting absorption lines</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Visualizing-the-full-quasar-model-fit">Visualizing the full quasar model fit</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Accessing-SpecModel-fit-results-and-saving-them">Accessing SpecModel fit results and saving them</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Full-fits,-fitting-algorithms,-and-saving-your-results">Full fits, fitting algorithms, and saving your results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Performing-a-global-consecutive-fit-and-saving-the-SpecModel-fit-results">Performing a global consecutive fit and saving the SpecModel fit results</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Choosing-the-fit-algorithm-available-in-LMFIT">Choosing the fit algorithm available in LMFIT</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Saving-the-model-fit">Saving the model fit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Loading-a-SpecFit-object-from-disk">Loading a SpecFit object from disk</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scripting_sculptor_2.html">Scripting Sculptor 02 - Analysing model fits with SpecAnalysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="scripting_sculptor_3.html">Scripting Sculptor 03 - Fitting and Analzying models using MCMC</a></li>
</ul>
<p class="caption"><span class="caption-text">Module documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="speconed.html">The SpecOneD Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="specmodel.html">The SpecModel Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="specfit.html">The SpecFit Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="specanalysis.html">The SpecAnalysis Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="masksmodels.html">The Masks &amp; Models Module</a></li>
</ul>
<p class="caption"><span class="caption-text">Extensions:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="qso_extension.html">The QSO-Extension Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="my_extension.html">Example extension Module</a></li>
</ul>
<p class="caption"><span class="caption-text">License:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Sculptor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Scripting Sculptor 01 - Modelling the example spectrum in a script</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/scripting_sculptor_1.nblink.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Scripting-Sculptor-01---Modelling-the-example-spectrum-in-a-script">
<h1>Scripting Sculptor 01 - Modelling the example spectrum in a script<a class="headerlink" href="#Scripting-Sculptor-01---Modelling-the-example-spectrum-in-a-script" title="Permalink to this headline">¶</a></h1>
<p>In this notebook we will introduce on how to use Sculptor’s SpecFit and SpecModel classes to generate a Sculptor fit within a python script.</p>
<p>The code in this example that generates the model fit is also available as a pure python script in the examples folder: <em>example_fit_setup_script.py</em></p>
<p>We begin by importing the modules we need for this example. In addition to the SpecFit, SpecModel, and SpecOneD classes we need <em>pkg_resources</em> to easily access the SDSS quasar example spectrum, which is provided in sculptor/data/example_spectra.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Matplotlib statements to make plots nice</span>
<span class="c1"># %matplotlib notebook</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">set_matplotlib_formats</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span>
<span class="c1"># set_matplotlib_formats(&#39;svg&#39;)</span>

</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pkg_resources</span>

<span class="kn">from</span> <span class="nn">sculptor</span> <span class="kn">import</span> <span class="n">specfit</span> <span class="k">as</span> <span class="n">scfit</span>
<span class="kn">from</span> <span class="nn">sculptor</span> <span class="kn">import</span> <span class="n">speconed</span> <span class="k">as</span> <span class="n">scspec</span>
<span class="kn">from</span> <span class="nn">sculptor</span> <span class="kn">import</span> <span class="n">specmodel</span> <span class="k">as</span> <span class="n">scmod</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[INFO] Import &#34;sculptor_extensions&#34; package: my_extension
[INFO] Import &#34;sculptor_extensions&#34; package: qso
[INFO] SWIRE library found.
[INFO] FeII iron template of Vestergaard &amp; Wilkes 2001 found. If you will be using these templates in your model fit and publication, please add the citation to the original work, ADS bibcode: 2001ApJS..134....1V
[INFO] FeII iron template of Tsuzuki et al. 2006 found. If you will be using these templates in your model fit and publication, please add the citation to the original work, ADS bibcode: 2006ApJ...650...57T
[INFO] FeII iron template of Boroson &amp; Green 1992 found. If you will be using these templates in your model fit and publication, please add the citation to the original work, ADS bibcode: 1992ApJS...80..109B
</pre></div></div>
</div>
<p>These imports automatically intialize some global variables, which allow you to use the model masks and functions defined in Sculptor and its extensions. We will take a look at how to write Sculptor extensions in a later tutorial. Sculptor comes with two extensions “my_extension”, which provides an example on how to set up your own extension, and the “qso” extension, which we will use heavily in this example. The “qso” extension also comes with additional data, e.g. FeII iron templates. If you
want to use them in your work Sculptor reminds you where to find the original papers, so you can cite them appropriately.</p>
<div class="section" id="Initializing-the-SpecFit-object">
<h2>Initializing the SpecFit object<a class="headerlink" href="#Initializing-the-SpecFit-object" title="Permalink to this headline">¶</a></h2>
<p>Let us begin by importing the SDSS quasar spectrum. The quasar is at a redshift of z=3.227, which we will use for initializing the SpecFit class.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Initialize a new SpecOneD object and read in the quasar spectrum</span>
<span class="n">spec</span> <span class="o">=</span> <span class="n">scspec</span><span class="o">.</span><span class="n">SpecOneD</span><span class="p">()</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;sculptor&#39;</span><span class="p">,</span> <span class="s1">&#39;data/example_spectra/J030341.04-002321.8_0.fits&#39;</span><span class="p">)</span>
<span class="n">spec</span><span class="o">.</span><span class="n">read_sdss_fits</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="n">redshift</span> <span class="o">=</span> <span class="mf">3.227</span>

<span class="c1"># Plot the quasar spectrum for confirmation that everything worked well.</span>
<span class="n">spec</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/scripting_sculptor_1_4_0.png" src="_images/scripting_sculptor_1_4_0.png" />
</div>
</div>
<p>In the next step we initialize the SpecFit object with the SpecOneD spectrum and also supply the redshift information.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Initialize SpecFit object</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">scfit</span><span class="o">.</span><span class="n">SpecFit</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">redshift</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The SpecFit object currently does not include any models and if we use the <em>.plot()</em> method, it will only show us the quasar spectrum. However, we can check the rest-frame dispersion axis, if the redshift keyword was used correctly.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fit</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/scripting_sculptor_1_8_0.png" src="_images/scripting_sculptor_1_8_0.png" />
</div>
</div>
</div>
<div class="section" id="Adding-our-first-SpecModel-object---Fitting-the-continuum">
<h2>Adding our first SpecModel object - Fitting the continuum<a class="headerlink" href="#Adding-our-first-SpecModel-object---Fitting-the-continuum" title="Permalink to this headline">¶</a></h2>
<p>In the next step we want to add a simple continuum model to our fit. However, we currently don’t really know which models and masks are available to us based on Sculptor and its loaded extensions. Let’s get a list of all model names and mask names. This information is available as a global variable in the sculptor.specmodel module:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MODEL FUNCTIONS:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">model_func</span> <span class="ow">in</span> <span class="n">scmod</span><span class="o">.</span><span class="n">model_func_list</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">model_func</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MASKS:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">scmod</span><span class="o">.</span><span class="n">mask_presets</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MODEL FUNCTIONS:
Constant (amp)
Power Law (amp, slope)
Gaussian (amp, cen, sigma, shift)
Lorentzian (amp, cen, gamma, shift)
My Model
Power Law (2500A)
Power Law (2500A) + BC
Power Law (2500A) + BC (fractional)
Line model Gaussian
SiIV (2G components)
CIV (2G components)
MgII (2G components)
HBeta (2G components)
HAlpha (2G components)
[OIII] doublet (2G)
[NII] doublet (2G)
[SII] doublet (2G)
CIII] complex (3G components)
SWIRE Ell2
SWIRE NGC6090
FeII template 1200-2200 (VW01, cont)
FeII template 1200-2200 (VW01, split)
FeII template 2200-3500 (VW01, cont)
FeII template 2200-3500 (VW01, split)
FeII template 2200-3500 (T06, cont)
FeII template 2200-3500 (T06, split)
FeII template 3700-7480 (BG92, cont)
FeII template 3700-5600 (BG92, split)


MASKS:
My mask
QSO Continuum+FeII
QSO Cont.W. VP06
QSO Fe+Cont.W. CIV Shen11
QSO Fe+Cont.W. MgII Shen11
QSO Fe+Cont.W. HBeta Shen11
QSO Fe+Cont.W. HAlpha Shen11
</pre></div></div>
</div>
<p>Using these models when writing Sculptor scripts usually requires to fully understand their parameters and functionality. Therefore, it is adviseable to study their source code, before attempting to write scripts.</p>
<p>In order to fit a model to the spectrum, we need to first add a SpecModel object to our fit (SpecFit object). Then we can access this SpecModel and add model functions to it. In order to fit the SpecModel</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Add the continuum SpecModel</span>
<span class="n">fit</span><span class="o">.</span><span class="n">add_specmodel</span><span class="p">()</span>
<span class="c1"># We access the initialized SpecModel object by using the first item in the SpecFit.specmodels list</span>
<span class="n">contmodel</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">specmodels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># Let us rename this SpecModel &#39;Continuum&#39;</span>
<span class="n">contmodel</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Continuum&#39;</span>

<span class="c1"># Define the model function name</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;Power Law (2500A)&#39;</span>
<span class="c1"># Define the model prefix</span>
<span class="c1"># It is important to keep track of the prefix to later access this model in the analysis</span>
<span class="n">model_prefix</span> <span class="o">=</span> <span class="s1">&#39;PL_&#39;</span>
<span class="c1"># Add the model function to the SpecModel</span>
<span class="n">contmodel</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_prefix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We have now added the model function to the SpecModel ‘Continuum’. However, we cannot yet fit the model successfully as we have not defined the regions to which the continuum model should be fit. Let us add them manually based. The exact fit regions for the continuum model of this quasar have been determined beforehand.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">contmodel</span><span class="o">.</span><span class="n">add_wavelength_range_to_fit_mask</span><span class="p">(</span><span class="mi">8300</span><span class="p">,</span> <span class="mi">8620</span><span class="p">)</span>
<span class="n">contmodel</span><span class="o">.</span><span class="n">add_wavelength_range_to_fit_mask</span><span class="p">(</span><span class="mi">7105</span><span class="p">,</span> <span class="mi">7205</span><span class="p">)</span>
<span class="n">contmodel</span><span class="o">.</span><span class="n">add_wavelength_range_to_fit_mask</span><span class="p">(</span><span class="mi">5400</span><span class="p">,</span> <span class="mi">5450</span><span class="p">)</span>
<span class="n">contmodel</span><span class="o">.</span><span class="n">add_wavelength_range_to_fit_mask</span><span class="p">(</span><span class="mi">5685</span><span class="p">,</span> <span class="mi">5750</span><span class="p">)</span>
<span class="n">contmodel</span><span class="o">.</span><span class="n">add_wavelength_range_to_fit_mask</span><span class="p">(</span><span class="mi">6145</span><span class="p">,</span> <span class="mi">6212</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[INFO] Manual mask range 8300 8620
[INFO] Manual mask range 7105 7205
[INFO] Manual mask range 5400 5450
[INFO] Manual mask range 5685 5750
[INFO] Manual mask range 6145 6212
</pre></div></div>
</div>
<p>Now that the fit mask has been updated we can fit the continuum model and plot the resulting fit. We can either use the <em>contmodel.plot()</em> function to only show the SpecModel components or use the <em>fit.plot()</em> function to show all SpecModels fits.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Fit the continuum model</span>
<span class="n">contmodel</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="c1"># Plot the fitted continuum model and the spectrum</span>
<span class="n">contmodel</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="c1"># Plot the SpecFit fit with all SpecModels (We only have 1 at the moment)</span>
<span class="n">fit</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/scripting_sculptor_1_16_0.png" src="_images/scripting_sculptor_1_16_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/scripting_sculptor_1_16_1.png" src="_images/scripting_sculptor_1_16_1.png" />
</div>
</div>
</div>
<div class="section" id="Adding-and-manipulating-a-SpecModel---Fitting-the-SiIV-line">
<h2>Adding and manipulating a SpecModel - Fitting the SiIV line<a class="headerlink" href="#Adding-and-manipulating-a-SpecModel---Fitting-the-SiIV-line" title="Permalink to this headline">¶</a></h2>
<p>In our next step we will add an emission line model to fit the SiIV emission line at a rest-frame wavelength of ~1400A. To do this we start by adding another SpecModel to our fit and specify the wavelength regions (in observed-frame) we want to use for the fit.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Add the SiIV emission line model</span>
<span class="n">fit</span><span class="o">.</span><span class="n">add_specmodel</span><span class="p">()</span>
<span class="c1"># Access the SpecModel object by choosing the second SpecModel object in the SpecFit</span>
<span class="c1"># specmodels list.</span>
<span class="n">siiv_model</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">specmodels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># Rename the SpecModel</span>
<span class="n">siiv_model</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SiIV_line&#39;</span>

<span class="c1"># Add wavelength regions to the SpecModel for the fit</span>
<span class="n">siiv_model</span><span class="o">.</span><span class="n">add_wavelength_range_to_fit_mask</span><span class="p">(</span><span class="mi">5790</span><span class="p">,</span> <span class="mi">5870</span><span class="p">)</span>
<span class="n">siiv_model</span><span class="o">.</span><span class="n">add_wavelength_range_to_fit_mask</span><span class="p">(</span><span class="mi">5910</span><span class="p">,</span> <span class="mi">6015</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[INFO] Manual mask range 5790 5870
[INFO] Manual mask range 5910 6015
</pre></div></div>
</div>
<p>However, we will use the pre-defined ‘SiIV (2G components)’ model function from the Sculptor qso extension, which has pre-defined model prefixes. Therefore, we pass a <em>None</em> as the model prefix here.</p>
<p>The model functions allow to pass additional keyword arguments that modify the redshift or amplitude of the emission line model. The redshift is automatically passed by the SpecModel class if we don’t specify a different value here. In this case we only want to pass an amplitude.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;SiIV (2G components)&#39;</span>
<span class="n">model_prefix</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">siiv_model</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_prefix</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The ‘SiIV (2G components)’ model function added two emission line models with the prefixes ‘SiIV_A_’ and ‘SiIV_B_’ to our SpecModel object. We can check whether the models were successfully added to the SpecModel object by accessing the SpecModel ‘model_list’. The items in the model list are LMFIT <em>Model</em> objects.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">siiv_model</span><span class="o">.</span><span class="n">model_list</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;lmfit.Model: Model(line_model_gaussian, prefix=&#39;SiIV_A_&#39;)&gt;
&lt;lmfit.Model: Model(line_model_gaussian, prefix=&#39;SiIV_B_&#39;)&gt;
</pre></div></div>
</div>
<p>We see that two model functions of the type ‘line_model_gaussian’ have been added to the SiIV SpecModel. By default the model function holds the redshift parameter fixed during the fit. However, for our purposes we want the redshift to be a variable. To change this we need to access the parameters of the model function.</p>
<p>The parameters for each of the models in the ‘model_list’ are stored in the ‘params_list’. Each item in the ‘params_list’ is a LMFIT <em>Parameters</em> object, holding the individual parameters of the associated model from the ‘model_list’.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">siiv_model</span><span class="o">.</span><span class="n">params_list</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Parameters([(&#39;SiIV_A_z&#39;, &lt;Parameter &#39;SiIV_A_z&#39;, value=3.227 (fixed), bounds=[3.0656499999999998:3.38835]&gt;), (&#39;SiIV_A_flux&#39;, &lt;Parameter &#39;SiIV_A_flux&#39;, value=106446.7019431226, bounds=[0:106446701.94312261]&gt;), (&#39;SiIV_A_cen&#39;, &lt;Parameter &#39;SiIV_A_cen&#39;, value=1399.8 (fixed), bounds=[-inf:inf]&gt;), (&#39;SiIV_A_fwhm_km_s&#39;, &lt;Parameter &#39;SiIV_A_fwhm_km_s&#39;, value=2500, bounds=[300:20000]&gt;)])


Parameters([(&#39;SiIV_B_z&#39;, &lt;Parameter &#39;SiIV_B_z&#39;, value=3.227 (fixed), bounds=[3.0656499999999998:3.38835]&gt;), (&#39;SiIV_B_flux&#39;, &lt;Parameter &#39;SiIV_B_flux&#39;, value=106446.7019431226, bounds=[0:106446701.94312261]&gt;), (&#39;SiIV_B_cen&#39;, &lt;Parameter &#39;SiIV_B_cen&#39;, value=1399.8 (fixed), bounds=[-inf:inf]&gt;), (&#39;SiIV_B_fwhm_km_s&#39;, &lt;Parameter &#39;SiIV_B_fwhm_km_s&#39;, value=2500, bounds=[300:20000]&gt;)])


</pre></div></div>
</div>
<p>To access a single LMFIT <em>Parameter</em> object from the <em>Parameters</em> we need to use its name, which consists of the model prefix and the parameter name, which are shown above.</p>
<p>By accessing a specific parameters we can change its attributes, defined in the LMFIT documentation: * name (str) – Name of the Parameter. * value (float, optional) – Numerical Parameter value * vary (bool, optional) – Whether the Parameter is varied during a fit (default is True). * min (float, optional) – Lower bound for value (default is -numpy.inf, no lower bound). * max (float, optional) – Upper bound for value (default is numpy.inf, no upper bound). * expr (str, optional) –
Mathematical expression used to constrain the value during the fit (default is None).</p>
<p>We will now change the <em>vary</em> attribute of the redshift parameters ‘SiIV_A_z’ of model function 0, and ‘SiIV_B_z’ of model function 1 to <em>True</em>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Make the redshifts variable parameters</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">siiv_model</span><span class="o">.</span><span class="n">params_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">params</span><span class="p">[</span><span class="s1">&#39;SiIV_A_z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">siiv_model</span><span class="o">.</span><span class="n">params_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">params</span><span class="p">[</span><span class="s1">&#39;SiIV_B_z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<p>Then we fit the SiIV SpecModel.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Fit the SiIV SpecModel</span>
<span class="n">siiv_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="c1"># Display the fitted SpecModel</span>
<span class="n">siiv_model</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/scripting_sculptor_1_28_0.png" src="_images/scripting_sculptor_1_28_0.png" />
</div>
</div>
</div>
<div class="section" id="Fitting-the-CIV-line">
<h2>Fitting the CIV line<a class="headerlink" href="#Fitting-the-CIV-line" title="Permalink to this headline">¶</a></h2>
<p>In the next step we add the CIV model, basically repeating the same procedure.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Add the CIV emission line model</span>
<span class="n">fit</span><span class="o">.</span><span class="n">add_specmodel</span><span class="p">()</span>
<span class="n">civ_model</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">specmodels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">civ_model</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;CIV_line&#39;</span>

<span class="n">civ_model</span><span class="o">.</span><span class="n">add_wavelength_range_to_fit_mask</span><span class="p">(</span><span class="mi">6240</span><span class="p">,</span> <span class="mi">6700</span><span class="p">)</span>

<span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;CIV (2G components)&#39;</span>
<span class="n">model_prefix</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">civ_model</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_prefix</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Make the redshift a variable parameter</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">civ_model</span><span class="o">.</span><span class="n">params_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">params</span><span class="p">[</span><span class="s1">&#39;CIV_A_z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">civ_model</span><span class="o">.</span><span class="n">params_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">params</span><span class="p">[</span><span class="s1">&#39;CIV_B_z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">civ_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">civ_model</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[INFO] Manual mask range 6240 6700
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/scripting_sculptor_1_30_1.png" src="_images/scripting_sculptor_1_30_1.png" />
</div>
</div>
</div>
<div class="section" id="Fitting-the-CIII]-line">
<h2>Fitting the CIII] line<a class="headerlink" href="#Fitting-the-CIII]-line" title="Permalink to this headline">¶</a></h2>
<p>After we successfully added the CIV line to the fit, we will now add a model for the SiIII], AlIII, and CIII] lines. While the previous SiIV and CIV model functions were comprised of two individual model functions called ‘line_model_gaussian’, the CIII] complex model is one model function comprised of three Gaussians with set central wavelength values.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Add the CIII] complex emission line model</span>
<span class="n">fit</span><span class="o">.</span><span class="n">add_specmodel</span><span class="p">()</span>
<span class="n">ciii_model</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">specmodels</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">ciii_model</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;CIII]_complex&#39;</span>

<span class="n">ciii_model</span><span class="o">.</span><span class="n">add_wavelength_range_to_fit_mask</span><span class="p">(</span><span class="mi">7800</span><span class="p">,</span> <span class="mi">8400</span><span class="p">)</span>

<span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;CIII] complex (3G components)&#39;</span>
<span class="n">model_prefix</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">ciii_model</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_prefix</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">ciii_model</span><span class="o">.</span><span class="n">params_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">params</span><span class="p">[</span><span class="s1">&#39;CIII_z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Initial fit</span>
<span class="n">ciii_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="c1"># Second fit to make sure the model converged</span>
<span class="n">ciii_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># Plot the model</span>
<span class="n">ciii_model</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[INFO] Manual mask range 7800 8400
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/scripting_sculptor_1_32_1.png" src="_images/scripting_sculptor_1_32_1.png" />
</div>
</div>
</div>
<div class="section" id="Adding-a-basic-line-model-(Gaussian)---Fitting-absorption-lines">
<h2>Adding a basic line model (Gaussian) - Fitting absorption lines<a class="headerlink" href="#Adding-a-basic-line-model-(Gaussian)---Fitting-absorption-lines" title="Permalink to this headline">¶</a></h2>
<p>Just blueward of the SiIV line this quasar has two prominent absorption features, which we also want to model. For this purpose we use the basic ‘Line model Gaussian’ model function and provide the parameters values as keyword arguments ourselves.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Add absorption line models</span>
<span class="n">fit</span><span class="o">.</span><span class="n">add_specmodel</span><span class="p">()</span>
<span class="n">abs_model</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">specmodels</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="n">abs_model</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Abs_lines&#39;</span>

<span class="n">abs_model</span><span class="o">.</span><span class="n">add_wavelength_range_to_fit_mask</span><span class="p">(</span><span class="mi">5760</span><span class="p">,</span> <span class="mi">5790</span><span class="p">)</span>

<span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;Line model Gaussian&#39;</span>
<span class="n">model_prefix</span> <span class="o">=</span> <span class="s1">&#39;Abs_A&#39;</span>
<span class="n">abs_model</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_prefix</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=-</span><span class="mi">15</span><span class="p">,</span>
                    <span class="n">cenwave</span><span class="o">=</span><span class="mi">5766</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">redshift</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;Line model Gaussian&#39;</span>
<span class="n">model_prefix</span> <span class="o">=</span> <span class="s1">&#39;Abs_B&#39;</span>
<span class="n">abs_model</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_prefix</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=-</span><span class="mi">15</span><span class="p">,</span>
                    <span class="n">cenwave</span><span class="o">=</span><span class="mi">5776</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">redshift</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">abs_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">abs_model</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[INFO] Manual mask range 5760 5790
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/scripting_sculptor_1_34_1.png" src="_images/scripting_sculptor_1_34_1.png" />
</div>
</div>
<p>The default <em>.plot()</em> function dispersion and flux ranges may not always be appropriate to check whether the model was actually fit appropriately. Using the <em>matplotlib notebook</em> functionality one can zoom into the region of the two absorption lines to check whether the SpecModel fit did a good job.</p>
</div>
<div class="section" id="Visualizing-the-full-quasar-model-fit">
<h2>Visualizing the full quasar model fit<a class="headerlink" href="#Visualizing-the-full-quasar-model-fit" title="Permalink to this headline">¶</a></h2>
<p>Let us now visualize the entire fit by calling the SpecFit plot function:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fit</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/scripting_sculptor_1_36_0.png" src="_images/scripting_sculptor_1_36_0.png" />
</div>
</div>
</div>
<div class="section" id="Accessing-SpecModel-fit-results-and-saving-them">
<h2>Accessing SpecModel fit results and saving them<a class="headerlink" href="#Accessing-SpecModel-fit-results-and-saving-them" title="Permalink to this headline">¶</a></h2>
<p>The fitted quasar model looks reasonable. However, in order to analyze the model we need to understand how to access the fitted parameters. Once a SpecModel has been fit, we can access the fit results simply by calling the <em>.fit_result</em> attribute of the SpecModel. It returns the LMFIT fit report for the SpecModel, giving us insight into the model that was fit, the fit statistics, the variables, and the correlations.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Printing the fit result for the CIV model</span>
<span class="n">civ_model</span><span class="o">.</span><span class="n">fit_result</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<h2> Model</h2> (Model(line_model_gaussian, prefix='CIV_A_') + Model(line_model_gaussian, prefix='CIV_B_')) <h2>Fit Statistics</h2><table><tr><td>fitting method</td><td>leastsq</td><td></td></tr><tr><td># function evals</td><td>121</td><td></td></tr><tr><td># data points</td><td>309</td><td></td></tr><tr><td># variables</td><td>6</td><td></td></tr><tr><td>chi-square</td><td> 431.940013</td><td></td></tr><tr><td>reduced chi-square</td><td> 1.42554460</td><td></td></tr><tr><td>Akaike info crit.</td><td> 115.498142</td><td></td></tr><tr><td>Bayesian info crit.</td><td> 137.898189</td><td></td></tr></table><h2>Variables</h2><table><tr><th> name </th><th> value </th><th> standard error </th><th> relative error </th><th> initial value </th><th> min </th><th> max </th><th> vary </th></tr><tr><td> CIV_A_z </td><td>  3.20972764 </td><td>  0.00149858 </td><td> (0.05%) </td><td> 3.227 </td><td>  3.06565000 </td><td>  3.38835000 </td><td> True </td></tr><tr><td> CIV_A_flux </td><td>  1820.82409 </td><td>  100.100791 </td><td> (5.50%) </td><td> 100 </td><td>  0.00000000 </td><td>  26611675.5 </td><td> True </td></tr><tr><td> CIV_A_cen </td><td>  1549.06000 </td><td>  0.00000000 </td><td> (0.00%) </td><td> 1549.06 </td><td>        -inf </td><td>         inf </td><td> False </td></tr><tr><td> CIV_A_fwhm_km_s </td><td>  12122.2834 </td><td>  611.964256 </td><td> (5.05%) </td><td> 2500 </td><td>  300.000000 </td><td>  20000.0000 </td><td> True </td></tr><tr><td> CIV_B_z </td><td>  3.20984418 </td><td>  7.2015e-04 </td><td> (0.02%) </td><td> 3.227 </td><td>  3.06565000 </td><td>  3.38835000 </td><td> True </td></tr><tr><td> CIV_B_flux </td><td>  1151.33782 </td><td>  114.160367 </td><td> (9.92%) </td><td> 100 </td><td>  0.00000000 </td><td>  26611675.5 </td><td> True </td></tr><tr><td> CIV_B_cen </td><td>  1549.06000 </td><td>  0.00000000 </td><td> (0.00%) </td><td> 1549.06 </td><td>        -inf </td><td>         inf </td><td> False </td></tr><tr><td> CIV_B_fwhm_km_s </td><td>  4791.00832 </td><td>  222.068758 </td><td> (4.64%) </td><td> 2500 </td><td>  300.000000 </td><td>  20000.0000 </td><td> True </td></tr></table><h2>Correlations (unreported correlations are < 0.100)</h2><table><tr><td>CIV_A_flux</td><td>CIV_B_flux</td><td>-0.9571</td></tr><tr><td>CIV_A_fwhm_km_s</td><td>CIV_B_flux</td><td>0.9133</td></tr><tr><td>CIV_B_flux</td><td>CIV_B_fwhm_km_s</td><td>0.9105</td></tr><tr><td>CIV_A_flux</td><td>CIV_B_fwhm_km_s</td><td>-0.9067</td></tr><tr><td>CIV_A_flux</td><td>CIV_A_fwhm_km_s</td><td>-0.8203</td></tr><tr><td>CIV_A_fwhm_km_s</td><td>CIV_B_fwhm_km_s</td><td>0.7812</td></tr><tr><td>CIV_A_z</td><td>CIV_B_z</td><td>-0.5566</td></tr><tr><td>CIV_A_z</td><td>CIV_A_fwhm_km_s</td><td>0.2409</td></tr><tr><td>CIV_A_z</td><td>CIV_B_flux</td><td>0.2348</td></tr><tr><td>CIV_A_z</td><td>CIV_A_flux</td><td>-0.2255</td></tr><tr><td>CIV_A_z</td><td>CIV_B_fwhm_km_s</td><td>0.2012</td></tr><tr><td>CIV_A_fwhm_km_s</td><td>CIV_B_z</td><td>-0.1323</td></tr><tr><td>CIV_B_z</td><td>CIV_B_flux</td><td>-0.1230</td></tr><tr><td>CIV_B_z</td><td>CIV_B_fwhm_km_s</td><td>-0.1201</td></tr><tr><td>CIV_A_flux</td><td>CIV_B_z</td><td>0.1194</td></tr></table></div>
</div>
<p>We can save the fit result of each individual SpecModel using the <em>save_fit_report</em> function. One has to supply the folder path where the fit report should be saved. As an example we can save the fit report for the CIV SpecModel to the current folder.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Save the CIV SpecModel fit report to the current folder</span>
<span class="n">civ_model</span><span class="o">.</span><span class="n">save_fit_report</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

<span class="c1"># Check if the fit report was saved</span>
<span class="o">!</span> ls
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TestSpectralBroadening.ipynb      specmodel_CIV_line_fit_report.txt
scripting_sculptor_1.ipynb        speconed_demonstration.ipynb
scripting_sculptor_2.ipynb        spectrum_preparation.ipynb
scripting_sculptor_3.ipynb
</pre></div></div>
</div>
<p>Let’s have a brief look at what was saved exactly:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">h</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;specmodel_CIV_line_fit_report.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">h</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="n">h</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[Fit Statistics]]

    # fitting method   = leastsq

    # function evals   = 121

    # data points      = 309

    # variables        = 6

    chi-square         = 431.940013

    reduced chi-square = 1.42554460

    Akaike info crit   = 115.498142

    Bayesian info crit = 137.898189

[[Variables]]

    CIV_A_z:          3.20972764 +/- 0.00149858 (0.05%) (init = 3.227)

    CIV_A_flux:       1820.82409 +/- 100.100791 (5.50%) (init = 100)

    CIV_A_cen:        1549.06 (fixed)

    CIV_A_fwhm_km_s:  12122.2834 +/- 611.964256 (5.05%) (init = 2500)

    CIV_B_z:          3.20984418 +/- 7.2015e-04 (0.02%) (init = 3.227)

    CIV_B_flux:       1151.33782 +/- 114.160367 (9.92%) (init = 100)

    CIV_B_cen:        1549.06 (fixed)

    CIV_B_fwhm_km_s:  4791.00832 +/- 222.068758 (4.64%) (init = 2500)

[[Correlations]] (unreported correlations are &lt; 0.100)

    C(CIV_A_flux, CIV_B_flux)           = -0.957

    C(CIV_A_fwhm_km_s, CIV_B_flux)      =  0.913

    C(CIV_B_flux, CIV_B_fwhm_km_s)      =  0.910

    C(CIV_A_flux, CIV_B_fwhm_km_s)      = -0.907

    C(CIV_A_flux, CIV_A_fwhm_km_s)      = -0.820

    C(CIV_A_fwhm_km_s, CIV_B_fwhm_km_s) =  0.781

    C(CIV_A_z, CIV_B_z)                 = -0.557

    C(CIV_A_z, CIV_A_fwhm_km_s)         =  0.241

    C(CIV_A_z, CIV_B_flux)              =  0.235

    C(CIV_A_z, CIV_A_flux)              = -0.225

    C(CIV_A_z, CIV_B_fwhm_km_s)         =  0.201

    C(CIV_A_fwhm_km_s, CIV_B_z)         = -0.132

    C(CIV_B_z, CIV_B_flux)              = -0.123

    C(CIV_B_z, CIV_B_fwhm_km_s)         = -0.120

    C(CIV_A_flux, CIV_B_z)              =  0.119
</pre></div></div>
</div>
<p>Wonderful! The full fit report, which we displayed above, was saved in the .txt file ‘specmodel_CIV line_fit_report.txt’. Let’s remove the file before we proceed.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span> rm specmodel_CIV_line_fit_report.txt
<span class="o">!</span> ls
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TestSpectralBroadening.ipynb scripting_sculptor_3.ipynb
scripting_sculptor_1.ipynb   speconed_demonstration.ipynb
scripting_sculptor_2.ipynb   spectrum_preparation.ipynb
</pre></div></div>
</div>
</div>
<div class="section" id="Full-fits,-fitting-algorithms,-and-saving-your-results">
<h2>Full fits, fitting algorithms, and saving your results<a class="headerlink" href="#Full-fits,-fitting-algorithms,-and-saving-your-results" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Performing-a-global-consecutive-fit-and-saving-the-SpecModel-fit-results">
<h3>Performing a global consecutive fit and saving the SpecModel fit results<a class="headerlink" href="#Performing-a-global-consecutive-fit-and-saving-the-SpecModel-fit-results" title="Permalink to this headline">¶</a></h3>
<p>In some cases it might be useful to fit individual SpecModels and save their results. However, in most cases we want to fit all SpecModels consecutively and save all results. For this purpose the SpecFit object has a function called <em>fit</em>. It can take a keyword argument <em>save_results</em>, which defaults to <em>False</em>. If we set it to <em>True</em> the fit results will automatically be saved to the current folder. By providing a different <em>foldername</em> keyword argument the user can choose the folder, where the
fit results will be saved.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Fit all SpecModels consecutively and save their results to the current folder</span>
<span class="n">fit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Check the current folder for the .txt files</span>
<span class="o">!</span> ls
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TestSpectralBroadening.ipynb      specmodel_2_FitAll_fit_report.txt
scripting_sculptor_1.ipynb        specmodel_3_FitAll_fit_report.txt
scripting_sculptor_2.ipynb        specmodel_4_FitAll_fit_report.txt
scripting_sculptor_3.ipynb        speconed_demonstration.ipynb
specmodel_0_FitAll_fit_report.txt spectrum_preparation.ipynb
specmodel_1_FitAll_fit_report.txt
</pre></div></div>
</div>
<p>Note that in this case, the SpecModels have not been saved with their given names, but rather with their list inidices in the specfit.specmodels list. However, if you used easy to understand model prefixes a simple look into the .txt files will let you recover the fit parameters easily.</p>
<p>To keep the notebook directory clean, let’s remove the files again:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Remove the SpecModel fit report files</span>
<span class="o">!</span> rm *.txt
<span class="c1"># Check the directory again</span>
<span class="o">!</span> ls
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TestSpectralBroadening.ipynb scripting_sculptor_3.ipynb
scripting_sculptor_1.ipynb   speconed_demonstration.ipynb
scripting_sculptor_2.ipynb   spectrum_preparation.ipynb
</pre></div></div>
</div>
</div>
<div class="section" id="Choosing-the-fit-algorithm-available-in-LMFIT">
<h3>Choosing the fit algorithm available in LMFIT<a class="headerlink" href="#Choosing-the-fit-algorithm-available-in-LMFIT" title="Permalink to this headline">¶</a></h3>
<p>The SpecFit object has a string attribute called <em>fitting_method</em>, which allows you to specify with which algorithm LMFIT will fit your model to the data. An overview over which algorithms are implemented in LMFIT can be found <a class="reference external" href="https://lmfit.github.io/lmfit-py/fitting.html">here</a>. The list of names available using Sculptor is saved as a global variable dictionary <em>fitting_methods</em> in the SpecModel module, that translates the human readable names of the algorithms into the LMFIT method
options. Note that not all of them are fully tested in the Sculptor framework and may lead to errors, if used inappropriately.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scmod</span><span class="o">.</span><span class="n">fitting_methods</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Name: </span><span class="si">{}</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> Method </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">scmod</span><span class="o">.</span><span class="n">fitting_methods</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Name: Levenberg-Marquardt
 Method leastsq
Name: Nelder-Mead
 Method nelder
Name: Maximum likelihood via Monte-Carlo Markov Chain
 Method emcee
Name: Least-Squares minimization
 Method least_squares
Name: Differential evolution
 Method differential_evolution
Name: Brute force method
 Method brute
Name: Basinhopping
 Method basinhopping
Name: Adaptive Memory Programming for Global Optimization
 Method ampgo
Name: L-BFGS-B
 Method lbfgsb
Name: Powell
 Method powell
Name: Conjugate-Gradient
 Method cg
Name: Cobyla
 Method cobyla
Name: BFGS
 Method bfgs
Name: Truncated Newton
 Method tnc
Name: Newton GLTR trust-region
 Method trust-krylov
Name: Trust-region for constrained obtimization
 Method trust-constr
Name: Sequential Linear Squares Programming
 Method slsqp
Name: Simplicial Homology Global Optimization
 Method shgo
Name: Dual Annealing Optimization
 Method dual_annealing
</pre></div></div>
</div>
<p>For more information on the different fitting algorithms, please refer to the LMFIT documentation.</p>
<p>The default method of Sculptor’s SpecFit class is always ‘Levenberg-Marquardt’. However, this can be easily changed:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Current fitting method</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Default fitting method: &#39;</span><span class="p">,</span> <span class="n">fit</span><span class="o">.</span><span class="n">fitting_method</span><span class="p">)</span>

<span class="c1"># Change fitting method to Nelder-Mead</span>
<span class="n">fit</span><span class="o">.</span><span class="n">fitting_method</span> <span class="o">=</span> <span class="s1">&#39;Nelder-Mead&#39;</span>

<span class="c1"># Check fitting method again</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New fitting method: &#39;</span><span class="p">,</span> <span class="n">fit</span><span class="o">.</span><span class="n">fitting_method</span><span class="p">)</span>

<span class="c1"># Fit all SpecModels</span>
<span class="n">fit</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="c1"># Display result</span>
<span class="n">fit</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>


</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Default fitting method:  Levenberg-Marquardt
New fitting method:  Nelder-Mead
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/scripting_sculptor_1_52_1.png" src="_images/scripting_sculptor_1_52_1.png" />
</div>
</div>
<p>Some of the fitting methods need extra parameters. A prominent example for this is the ‘Maximum likelihood via Monte-Carlo Markov Chain’, which uses emcee to perform a maximum likelihood fit using MCMC. For this particular method default parameters are implemented. However, we will devote an entire notebook to show how you can use this fitting option to produce science grade results.</p>
</div>
<div class="section" id="Saving-the-model-fit">
<h3>Saving the model fit<a class="headerlink" href="#Saving-the-model-fit" title="Permalink to this headline">¶</a></h3>
<p>One of the goals of the Sculptor package is to enable easy reproducibility of model fits to astronomical spectra and their analysis. Therefore, you can save your entire fit (SpecFit object) to a folder with the SpecFit <em>save</em> function. It takes the folderpath+foldername as an attribute and will create the folder if it does not find it in the specified directory.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Quick look into the current directory</span>
<span class="o">!</span> ls

<span class="c1"># Save the SpecFit object</span>
<span class="n">fit</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;example_fit_notebook&#39;</span><span class="p">)</span>

<span class="c1"># Check if the folder was created and contents were saved</span>
<span class="o">!</span> ls
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TestSpectralBroadening.ipynb scripting_sculptor_3.ipynb
scripting_sculptor_1.ipynb   speconed_demonstration.ipynb
scripting_sculptor_2.ipynb   spectrum_preparation.ipynb
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/anaconda3/envs/sculptor-env/lib/python3.9/site-packages/pandas/core/generic.py:2606: PerformanceWarning:
your performance may suffer as PyTables will pickle object types that it cannot
map directly to c-types [inferred_type-&gt;mixed-integer,key-&gt;block0_values] [items-&gt;Index([&#39;value&#39;], dtype=&#39;object&#39;)]

  pytables.to_hdf(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[INFO] Saving SpecModel fit result
[INFO] Saving new model file: example_fit_notebook/0_PL__model.json
[INFO] Saving SpecModel fit result
[INFO] Saving new model file: example_fit_notebook/1_SiIV_A__model.json
[INFO] Saving new model file: example_fit_notebook/1_SiIV_B__model.json
[INFO] Saving SpecModel fit result
[INFO] Saving new model file: example_fit_notebook/2_CIV_A__model.json
[INFO] Saving new model file: example_fit_notebook/2_CIV_B__model.json
[INFO] Saving SpecModel fit result
[INFO] Saving new model file: example_fit_notebook/3_CIII__model.json
[INFO] Saving SpecModel fit result
[INFO] Saving new model file: example_fit_notebook/4_Abs_A_model.json
[INFO] Saving new model file: example_fit_notebook/4_Abs_B_model.json
TestSpectralBroadening.ipynb scripting_sculptor_3.ipynb
<span class="ansi-blue-fg">example_fit_notebook</span>         speconed_demonstration.ipynb
scripting_sculptor_1.ipynb   spectrum_preparation.ipynb
scripting_sculptor_2.ipynb
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Check the contents of the saved SpecFit folder</span>
<span class="o">!</span> ls ./example_fit_notebook/
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0_PL__model.json          2_fitresult.json          specmodel_0_specdata.hdf5
0_fitresult.json          3_CIII__model.json        specmodel_1_specdata.hdf5
1_SiIV_A__model.json      3_fitresult.json          specmodel_2_specdata.hdf5
1_SiIV_B__model.json      4_Abs_A_model.json        specmodel_3_specdata.hdf5
1_fitresult.json          4_Abs_B_model.json        specmodel_4_specdata.hdf5
2_CIV_A__model.json       4_fitresult.json          spectrum.hdf5
2_CIV_B__model.json       fit.hdf5
</pre></div></div>
</div>
<p>At this point we do not want to go into detail into all the saved files. The <em>fit.hdf5</em> saved the main attributes of the SpecFit and SpecModel objects. The individual models and their fit results were saved as <em>.json</em> files via the LMFIT functionality for saving models, parameters, and results. The input spectrum is saved as the <em>spectrum.hdf5</em> file and the spectra of the SpecModel objects, along with the mask regions and model spectra are saved in the <em>specmodel_X_specdata.hdf5</em> files.</p>
</div>
<div class="section" id="Loading-a-SpecFit-object-from-disk">
<h3>Loading a SpecFit object from disk<a class="headerlink" href="#Loading-a-SpecFit-object-from-disk" title="Permalink to this headline">¶</a></h3>
<p>We can now use the Sculptor GUI to now load the full model fit (SpecFit object) into the GUI from the folder we saved it to and then manipulate it to tune the fit.</p>
<p>Of course we can also instantiate a new SpecFit object and then load the previous result. This is quite simple:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Instantiate an empty SpecFit object</span>
<span class="n">new_fit</span> <span class="o">=</span> <span class="n">scfit</span><span class="o">.</span><span class="n">SpecFit</span><span class="p">()</span>

<span class="c1"># Load the saved model fit using the folder name</span>
<span class="n">new_fit</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;example_fit_notebook&#39;</span><span class="p">)</span>

<span class="c1"># Fit all SpecModels and then display the fit to see if everything worked</span>
<span class="n">new_fit</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">new_fit</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="c1"># We can also check if it saved the fitting method we changed earlier</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_fit</span><span class="o">.</span><span class="n">fitting_method</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/scripting_sculptor_1_59_0.png" src="_images/scripting_sculptor_1_59_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Nelder-Mead
</pre></div></div>
</div>
<p>The full fit you see displayed above should resemble the one a few cells earlier, where we tested changing the fitting method. With this we conclude the demonstration on how to use scripts to construct, fit and save Sculptor model fits.</p>
<p>(We delete the save Sculptor fit to keep the notebook directory clean)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Delete the Sculptor model fit folder</span>
<span class="o">!</span> rm -r example_fit_notebook
<span class="c1"># Check the directory</span>
<span class="o">!</span> ls
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TestSpectralBroadening.ipynb scripting_sculptor_3.ipynb
scripting_sculptor_1.ipynb   speconed_demonstration.ipynb
scripting_sculptor_2.ipynb   spectrum_preparation.ipynb
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="scripting_sculptor_2.html" class="btn btn-neutral float-right" title="Scripting Sculptor 02 - Analysing model fits with SpecAnalysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="spectrum_preparation.html" class="btn btn-neutral float-left" title="Preparing a composite spectrum for Sculptor modeling using the SpecOneD class" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Jan-Torge Schindler.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>